
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.4/select2.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-css/1.4.6/select2-bootstrap.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.4/select2.min.js"></script>

<style>
#divclasslabormarket {
display: block;
max-width: 944px;
max-height: 472px;
margin: auto;
}

</style>

<div id="div_gender_vs_labor_market" class="col-md-12">
	<form id="myform3" action="" onchange="handlerClassLaborMarket">
	{% csrf_token %}
	<label for="statesClassXLaborMarket">Escolha a UF da empresa:</label>
	<input id="statesClassXLaborMarket">
	<br>
	<label for="companyClassXLaborMarket">Escolha a empresa:</label>
	<input id="companyClassXLaborMarket" style="width:100%;">
	<br>
	<label for="areaClassXLaborMarket">Escolha a area:</label>
	<input id="areaClassXLaborMarket" style="width:50%;">
	</form>
	<div id="divclasslabormarket">
		<div id="no-data-class-vs-labor-market">
        	<h2>Informação insuficiente para gerar o gráfico</h2>
    	</div>
		<canvas id="classeXmercadodetrabalho"></canvas>
	</div>
</div>

<!-- Create Request based on the parameters -->
<script>
	function changeValuesinRequest(request)
	{
		var final_request = {};
		$.each($('#myform').serializeArray(), function(_, kv) {
		  final_request[kv.name] = kv.value;
		});
		var companyValue = $("#companyClassXLaborMarket").select2('data').text;
		final_request["companyClassXLaborMarket"] = companyValue
	    var stateValue = $("#statesClassXLaborMarket").select2('data').text;
		final_request["statesClassXLaborMarket"] = stateValue
		var areaValue = $("#areaClassXLaborMarket").select2('data').text;
		final_request["areaClassXLaborMarket"] = areaValue
		final_request["graph_name"] = "classeXmercadodetrabalho"
		return final_request
	}

</script>

<!-- Funções jQuery de atualização e afins -->
<script>

const handlerClassLaborMarket = function(e) {
   var formData = $('#myform').serializeArray()
   formData = changeValuesinRequest(formData)
   e.preventDefault(); // avoid to execute the actual submit of the form.
   $.ajax({
        url: "/update_graph/",
        data: formData,
        dataType: 'json',
        type: 'POST',
        success: function (data, status) {
				oldStateValue = classLaborMarket["State"]
        		classLaborMarket = data.classeXmercadodetrabalho
				updateGraphClassLaborMarket(classLaborMarket)

				$("#areaClassXLaborMarket").empty();
				initValuesClassLaborMarket("Areas", "Area", "#areaClassXLaborMarket")

				$("#statesClassXLaborMarket").empty();
				initValuesClassLaborMarket("States", "State", "#statesClassXLaborMarket")

				if (oldStateValue != classLaborMarket.State)
				{
					$("#companyClassXLaborMarket").empty();
					initValuesClassLaborMarket("Empresas", "Empresa", "#companyClassXLaborMarket")
				}
        }
    });
}

$('#companyClassXLaborMarket').on('change', handlerClassLaborMarket)
$('#statesClassXLaborMarket').on('change', handlerClassLaborMarket)
$('#areaClassXLaborMarket').on('change', handlerClassLaborMarket)

</script>

<!-- Método que realiza a atualização do gráfico -->
<script>
function updateGraphClassLaborMarket(object_all){
	if (Object.keys(object_all).length == 0 || Object.keys(object_all["Data"]).length == 0)
	{
		document.getElementById('no-data-class-vs-labor-market').style.display = 'block';
        document.getElementById('classeXmercadodetrabalho').style.display = 'none'
	}
	else
	{
	document.getElementById('no-data-class-vs-labor-market').style.display = 'none';
	document.getElementById('classeXmercadodetrabalho').style.display = 'block'

	var colorArray = ["green", "blue", "black", "red" , "purple"]
	chartClassLaborMarket.data.labels = object_all["Labels"]
	chartClassLaborMarket.data.datasets[0].label = object_all["Area"]
	chartClassLaborMarket.data.datasets[0].backgroundColor = colorArray
	chartClassLaborMarket.data.datasets[0].data = object_all["Data"]
	chartClassLaborMarket.options.title.text = 'Genero X Area de ' + object_all["Area"]
	chartClassLaborMarket.update();
	}
}


</script>

<!-- Função que cria o gráfico inicialmente -->
<script>
function createGraphClassLaborMarket(object_all)
{
	var colorArray = ["green", "blue", "black", "red" , "purple"]

	chartClassLaborMarket = new Chart(document.getElementById("classeXmercadodetrabalho"), {
	type: 'pie',
	data: {
	  labels: object_all["Labels"],
	  datasets: [{
		label : object_all["Area"],
		backgroundColor: colorArray,
		data: object_all["Data"]
	}]
	},
	options: {
	  title: {
		display: true,
		text: 'Genero X Area de ' + object_all["Area"]
	  },
	  plugins: {
		datalabels: {
		formatter: (value, ctx) => {
		  let sum = 0;
		  let dataArr = ctx.chart.data.datasets[0].data;
		  dataArr.map(data => {
			  sum += data;
		  });
		  let percentage = (value*100 / sum).toFixed(2)+"%";
		  return percentage;


		},
		color: '#fff',
		}
	}
	},
	});
}

</script>

<!-- Função do método init -->
<script>
function initClassLaborMarket(object_all) {

	if (Object.keys(object_all).length == 0)
	{
		document.getElementById("no-data-class-vs-labor-market").innerHTML = "Sem informações suficientes para gerar os gráficos!";
	}
	else
	{
	initValuesClassLaborMarket("Empresas", "Empresa", "#companyClassXLaborMarket")
	initValuesClassLaborMarket("Areas", "Area", "#areaClassXLaborMarket")
	initValuesClassLaborMarket("States", "State", "#statesClassXLaborMarket")

	createGraphClassLaborMarket(object_all)
	}
}

</script>

<script>

function initValuesClassLaborMarket(all_fields, field, divNameWithTag) {
	var testData = [];

	testData.push(
		{
		id : 0,
		text: "Todos"
		});
	// Instead of doing this use the AJAX call to poulate the data.
	for (var i=0; i < classLaborMarket[all_fields].length; i++) {
		testData.push(
		{
		id : i+1,
		text: classLaborMarket[all_fields][i]
		});
	}



	$(divNameWithTag).select2({
	  data: testData,
	  multiple: false,
	  query: function(q) {
      var pageSize,
        results,
        that = this;
      pageSize = 20; // or whatever pagesize
      results = [];
      if (q.term && q.term !== '') {
        // HEADS UP; for the _.filter function i use underscore (actually lo-dash) here
        results = _.filter(that.data, function(e) {
          return e.text.toUpperCase().indexOf(q.term.toUpperCase()) >= 0;
        });
      } else if (q.term === '') {
        results = that.data;
      }
      q.callback({
        results: results.slice((q.page - 1) * pageSize, q.page * pageSize),
        more: results.length >= q.page * pageSize,
      });
    }
	})

	var data = testData.find(o => o.text === classLaborMarket[field])

	$(divNameWithTag).select2("data", data);
}
</script>

<!-- Execucao inicial do método init -->
<script>
	document.getElementById('no-data-class-vs-labor-market').style.display = 'none';
	var chartClassLaborMarket;
	var classLaborMarket = {{ classeXmercadodetrabalho | safe }}
	initClassLaborMarket(classLaborMarket);
</script>
