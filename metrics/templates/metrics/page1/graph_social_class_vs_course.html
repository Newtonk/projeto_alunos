
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>

<style>
#divclasscourse {
display: block;
max-width: 944px;
max-height: 472px;
margin: auto;
}

</style>

<div id="div_class_vs_course" class="col-md-12">
	<form id="myform3" action="" onchange="handlerClassCourse">
	{% csrf_token %}
	<label for="courseClassXCourse">Escolha o curso:</label>
	<select name="courseClassXCourse" id="courseClassXCourse" ></select>
	<br>
	<label for="statesClassXCourse">Escolha a UF da universidade:</label>
	<select name="statesClassXCourse" id="statesClassXCourse" ></select>
	<label for="universityClassXCourse">Escolha a universidade:</label>
	<select name="universityClassXCourse" id="universityClassXCourse" ></select>
	</form>
	<div id="divclasscourse">
		<div id="no-data-class-vs-curso">
        	<h2>Informação insuficiente para gerar o gráfico</h2>
    	</div>
		<canvas id="classeXcurso"></canvas>
	</div>
</div>

<!-- Create Request based on the parameters -->
<script>
	function createRequest()
	{
		request = {}
		var companyValue = $("#companyGenderXLaborMarket").select2('data').text;
		request["companyGenderXLaborMarket"] = companyValue
	    var stateValue = $("#statesGenderXLaborMarket").select2('data').text;
		request["statesGenderXLaborMarket"] = stateValue
		var areaValue = $("#areaGenderXLaborMarket").select2('data').text;
		request["areaGenderXLaborMarket"] = areaValue
		request["graph_name"] = "generoXmercadodetrabalho"
		request["csrfmiddlewaretoken"] = "{{ csrf_token }}"
		return request
	}

</script>

<!-- Funções jQuery de atualização e afins -->
<script>
const handlerClassCourse = function(e) {
   var formData = $('#myform3').serialize()
   e.preventDefault(); // avoid to execute the actual submit of the form.
   $.ajax({
        url: "/update_graph/",
        data: formData + "&graph_name=classeXcurso",
        cache: false,
        dataType: 'json',
        type: 'POST',
        success: function (data, status) {
        		classCourse = data.classeXcurso
				updateGraphClassCourse(classCourse)
				select = document.getElementById("courseClassXCourse")
				select.value = classCourse.Course;
				select = document.getElementById("statesClassXCourse")
				select.value = classCourse.State;

				select = document.getElementById("universityClassXCourse")
				 $("#universityClassXCourse").empty();
				 var option = document.createElement("option");
				 option.value = "Todos";
				 option.text = "Todos";
				 select.appendChild(option);

				 instValues = classCourse.Instituicoes;

				 for (const value of instValues)
				 {
					  var option = document.createElement("option");
					  option.value = value;
					  option.text = value.charAt(0).toUpperCase() + value.slice(1);
					  select.appendChild(option);
				 }
				 select.value = classCourse.Instituicao;

 				$("#courseClassXCourse").empty();
				selectCourse = document.getElementById("courseClassXCourse")
				var option = document.createElement("option");
				option.value = "Todos";
				option.text = "Todos";
				selectCourse.appendChild(option);

				all_courses = classCourse.Courses;

				for (const course of all_courses)
				{
					var option = document.createElement("option");
					option.value = course;
					option.text = course.charAt(0).toUpperCase() + course.slice(1);
					selectCourse.appendChild(option);
				}
				selectCourse.value = classCourse.Course;

        }
    });
}

var select = document.getElementById('myform3');
select.addEventListener('change', handlerClassCourse);

</script>

<!-- Método que realiza a atualização do gráfico -->
<script>
function updateGraphClassCourse(object_all){
	if (Object.keys(object_all).length == 0 || Object.keys(object_all["Data"]).length == 0)
	{
		document.getElementById('no-data-class-vs-curso').style.display = 'block';
        document.getElementById('classeXcurso').style.display = 'none'
	}
	else
	{
	document.getElementById('no-data-class-vs-curso').style.display = 'none';
	document.getElementById('classeXcurso').style.display = 'block'

	var colorArray = ["green", "blue", "black", "red" , "purple"]
	chartClassCourse.data.labels = object_all["Labels"]
	chartClassCourse.data.datasets[0].label = object_all["Course"]
	chartClassCourse.data.datasets[0].backgroundColor = colorArray
	chartClassCourse.data.datasets[0].data = object_all["Data"]
	chartClassCourse.options.title.text = 'Genero X Curso de ' + object_all["Course"]
	chartClassCourse.update();
	}
}


</script>

<!-- Função que cria o gráfico inicialmente -->
<script>
function createGraphClassCourse(object_all)
{
	var colorArray = ["green", "blue", "black", "red" , "purple"]

	chartClassCourse = new Chart(document.getElementById("classeXcurso"), {
	type: 'pie',
	data: {
	  labels: object_all["Labels"],
	  datasets: [{
		label : object_all["Course"],
		backgroundColor: colorArray,
		data: object_all["Data"]
	}]
	},
	options: {
	  title: {
		display: true,
		text: 'Genero X Curso de ' + object_all["Course"]
	  },
	  plugins: {
		datalabels: {
		formatter: (value, ctx) => {
		  let sum = 0;
		  let dataArr = ctx.chart.data.datasets[0].data;
		  dataArr.map(data => {
			  sum += data;
		  });
		  let percentage = (value*100 / sum).toFixed(2)+"%";
		  return percentage;


		},
		color: '#fff',
		}
	}
	},
	});
}

</script>

<!-- Função do método init -->
<script>
function initClassCourse(object_all) {

	if (Object.keys(object_all).length == 0)
	{
		document.getElementById("div_class_vs_course").innerHTML = "Sem informações suficientes para gerar os gráficos!";
	}
	else
	{
	document.getElementById("courseClassXCourse").value = object_all["Course"];

	selectCourse = document.getElementById("courseClassXCourse")

	all_courses = object_all["Courses"];

	var option = document.createElement("option");
	option.value = "Todos";
	option.text = "Todos";
	selectCourse.appendChild(option);

	for (const course of all_courses)
	{
		var option = document.createElement("option");
		option.value = course;
		option.text = course.charAt(0).toUpperCase() + course.slice(1);
		selectCourse.appendChild(option);
	}
	selectCourse.value = object_all["Course"];

	selectState = document.getElementById("statesClassXCourse")

	all_states = object_all["States"];

	var option = document.createElement("option");
	option.value = "Todos";
	option.text = "Todos";
	selectState.appendChild(option);

	for (const state of all_states)
	{
		var option = document.createElement("option");
		option.value = state;
		option.text = state.charAt(0).toUpperCase() + state.slice(1);
		selectState.appendChild(option);
	}
	selectState.value = object_all["State"];

	selectUni = document.getElementById("universityClassXCourse")

	all_universities = object_all["Instituicoes"];

	var option = document.createElement("option");
	option.value = "Todos";
	option.text = "Todos";
	selectUni.appendChild(option);

	for (const university of all_universities)
	{
		var option = document.createElement("option");
		option.value = university;
		option.text = university.charAt(0).toUpperCase() + university.slice(1);
		selectUni.appendChild(option);
	}
	selectUni.value = object_all["Instituicao"];

	createGraphClassCourse(object_all)
	}
}

</script>

<!-- Execucao inicial do método init -->
<script>
	document.getElementById('no-data-class-vs-curso').style.display = 'none';
	var chartClassCourse;
	var classCourse = {{ classeXcurso | safe }}
	initClassCourse(classCourse);
</script>