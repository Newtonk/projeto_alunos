
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.4/select2.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-css/1.4.6/select2-bootstrap.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.4/select2.min.js"></script>

<style>
#divgenerolabormarket {
display: block;
max-width: 944px;
max-height: 472px;
margin: auto;
}

</style>

<div id="div_gender_vs_labor_market" class="col-md-12">
	<form id="myform" action="" onchange="handlerGenderLaborMarket">
	{% csrf_token %}
	<label for="statesUniGenderXLaborMarket">Escolha a UF da universidade:</label>
	<input id="statesUniGenderXLaborMarket">
	<br>
	<label for="universityGenderXLaborMarket">Escolha a universidade:</label>
	<input id="universityGenderXLaborMarket">
	<br>
	<label for="courseGenderXLaborMarket">Escolha o curso:</label>
	<input id="courseGenderXLaborMarket">
	<br>
	<label for="statesGenderXLaborMarket">Escolha a UF da empresa:</label>
	<input id="statesGenderXLaborMarket">
	<br>
	<label for="companyGenderXLaborMarket">Escolha a empresa:</label>
	<input id="companyGenderXLaborMarket" style="width:100%;">
	<br>
	<label for="areaGenderXLaborMarket">Escolha a area:</label>
	<input id="areaGenderXLaborMarket" style="width:50%;">
	</form>
	<div id="divgenerolabormarket">
		<div id="no-data-gender-vs-labor-market">
        	<h2>Informação insuficiente para gerar o gráfico</h2>
    	</div>
		<canvas id="generoXmercadodetrabalho"></canvas>
	</div>
</div>

<!-- Create Request based on the parameters -->
<script>
	function changeValuesinRequestGenderLaborMarket(request)
	{
		var final_request = {};
		$.each($('#myform').serializeArray(), function(_, kv) {
		  final_request[kv.name] = kv.value;
		});
		var companyValue = $("#companyGenderXLaborMarket").select2('data').text;
		final_request["companyGenderXLaborMarket"] = companyValue

	    var stateValue = $("#statesGenderXLaborMarket").select2('data').text;
		final_request["statesGenderXLaborMarket"] = stateValue

		var areaValue = $("#areaGenderXLaborMarket").select2('data').text;
		final_request["areaGenderXLaborMarket"] = areaValue

		var courseValue = $("#courseGenderXLaborMarket").select2('data').text;
		final_request["courseGenderXLaborMarket"] = courseValue

	    var stateUniValue = $("#statesUniGenderXLaborMarket").select2('data').text;
		final_request["statesUniGenderXLaborMarket"] = stateUniValue

		var universityValue = $("#universityGenderXLaborMarket").select2('data').text;
		final_request["universityGenderXLaborMarket"] = universityValue

		final_request["graph_name"] = "generoXmercadodetrabalho"
		return final_request
	}

</script>

<!-- Funções jQuery de atualização e afins -->
<script>

const handlerGenderLaborMarket = function(e) {
   var formData = $('#myform').serializeArray()
   formData = changeValuesinRequestGenderLaborMarket(formData)
   e.preventDefault(); // avoid to execute the actual submit of the form.
   $.ajax({
        url: "/update_graph/",
        data: formData,
        dataType: 'json',
        type: 'POST',
        success: function (data, status) {
				oldStateValue = genderLaborMarket["State"]
        		genderLaborMarket = data.generoXmercadodetrabalho
				updateGraphGenderLaborMarket(genderLaborMarket)

				$("#areaGenderXLaborMarket").empty();
				initValuesGenderLaborMarket("Areas", "Area", "#areaGenderXLaborMarket")

				$("#statesGenderXLaborMarket").empty();
				initValuesGenderLaborMarket("CompanyStates", "CompanyState", "#statesGenderXLaborMarket")

				$("#companyGenderXLaborMarket").empty();
				initValuesGenderLaborMarket("Companies", "Company", "#companyGenderXLaborMarket")

				$("#universityGenderXLaborMarket").empty();
				initValuesGenderLaborMarket("UniversityStates", "UniversityState", "#universityGenderXLaborMarket")

				$("#universityGenderXLaborMarket").empty();
				initValuesGenderLaborMarket("Universities", "University", "#universityGenderXLaborMarket")

				$("#courseGenderXLaborMarket").empty();
				initValuesGenderLaborMarket("Courses", "Course", "#courseGenderXLaborMarket")
        }
    });
}

$('#companyGenderXLaborMarket').on('change', handlerGenderLaborMarket)
$('#statesGenderXLaborMarket').on('change', handlerGenderLaborMarket)
$('#areaGenderXLaborMarket').on('change', handlerGenderLaborMarket)

$('#courseGenderXLaborMarket').on('change', handlerGenderLaborMarket)
$('#statesUniGenderXLaborMarket').on('change', handlerGenderLaborMarket)
$('#universityGenderXLaborMarket').on('change', handlerGenderLaborMarket)

</script>

<!-- Método que realiza a atualização do gráfico -->
<script>
function updateGraphGenderLaborMarket(object_all){
	if (Object.keys(object_all).length == 0 || Object.keys(object_all["Data"]).length == 0)
	{
		document.getElementById('no-data-gender-vs-labor-market').style.display = 'block';
        document.getElementById('generoXmercadodetrabalho').style.display = 'none'
	}
	else
	{
	document.getElementById('no-data-gender-vs-labor-market').style.display = 'none';
	document.getElementById('generoXmercadodetrabalho').style.display = 'block'
	var colorArray = ["green", "blue", "black"]
	chartGenderLaborMarket.data.labels = object_all["Labels"]
	chartGenderLaborMarket.data.datasets[0].label = object_all["Area"]
	chartGenderLaborMarket.data.datasets[0].backgroundColor = colorArray
	chartGenderLaborMarket.data.datasets[0].data = object_all["Data"]
	chartGenderLaborMarket.options.title.text = 'Genero X Area de ' + object_all["Area"]
	chartGenderLaborMarket.update();
	}
}


</script>

<!-- Função que cria o gráfico inicialmente -->
<script>
function createGraphGenderLaborMarket(object_all)
{
	var colorArray = ["green", "blue", "black", "red" , "purple"]

	chartGenderLaborMarket = new Chart(document.getElementById("generoXmercadodetrabalho"), {
	type: 'pie',
	data: {
	  labels: object_all["Labels"],
	  datasets: [{
		label : object_all["Area"],
		backgroundColor: colorArray,
		data: object_all["Data"]
	}]
	},
	options: {
	  title: {
		display: true,
		text: 'Genero X Area de ' + object_all["Area"]
	  },
	  plugins: {
		datalabels: {
		formatter: (value, ctx) => {
		  let sum = 0;
		  let dataArr = ctx.chart.data.datasets[0].data;
		  dataArr.map(data => {
			  sum += data;
		  });
		  let percentage = (value*100 / sum).toFixed(2)+"%";
		  return percentage;


		},
		color: '#fff',
		}
	}
	},
	});
}

</script>

<!-- Função do método init -->
<script>
function initGenderLaborMarket(object_all) {

	if (Object.keys(object_all).length == 0)
	{
		document.getElementById("div_gender_vs_labor_market").innerHTML = "Sem informações suficientes para gerar os gráficos!";
	}
	else
	{
	if (Object.keys(object_all["Data"]).length == 0)
	{
		document.getElementById('no-data-gender-vs-labor-market').style.display = 'block';
        document.getElementById('generoXmercadodetrabalho').style.display = 'none'
	}
	initValuesGenderLaborMarket("Companies", "Company", "#companyGenderXLaborMarket")
	initValuesGenderLaborMarket("Areas", "Area", "#areaGenderXLaborMarket")
	initValuesGenderLaborMarket("CompanyStates", "CompanyState", "#statesGenderXLaborMarket")
	initValuesGenderLaborMarket("UniversityStates", "UniversityState", "#statesUniGenderXLaborMarket")
	initValuesGenderLaborMarket("Universities", "University", "#universityGenderXLaborMarket")
	initValuesGenderLaborMarket("Courses", "Course", "#courseGenderXLaborMarket")

	createGraphGenderLaborMarket(object_all)
	}
}

</script>

<script>

function initValuesGenderLaborMarket(all_fields, field, divNameWithTag) {
	var testData = [];

	testData.push(
		{
		id : 0,
		text: "Todos"
		});
	// Instead of doing this use the AJAX call to poulate the data.
	for (var i=0; i < genderLaborMarket[all_fields].length; i++) {
		testData.push(
		{
		id : i+1,
		text: genderLaborMarket[all_fields][i]
		});
	}



	$(divNameWithTag).select2({
	  data: testData,
	  multiple: false,
	  query: function(q) {
      var pageSize,
        results,
        that = this;
      pageSize = 20; // or whatever pagesize
      results = [];
      if (q.term && q.term !== '') {
        // HEADS UP; for the _.filter function i use underscore (actually lo-dash) here
        results = _.filter(that.data, function(e) {
          return e.text.toUpperCase().indexOf(q.term.toUpperCase()) >= 0;
        });
      } else if (q.term === '') {
        results = that.data;
      }
      q.callback({
        results: results.slice((q.page - 1) * pageSize, q.page * pageSize),
        more: results.length >= q.page * pageSize,
      });
    }
	})

	var data = testData.find(o => o.text === genderLaborMarket[field])

	$(divNameWithTag).select2("data", data);
}
</script>

<!-- Execucao inicial do método init -->
<script>
	document.getElementById('no-data-gender-vs-labor-market').style.display = 'none';
	var chartGenderLaborMarket;
	var genderLaborMarket = {{ generoXmercadodetrabalho | safe }}
	initGenderLaborMarket(genderLaborMarket);
</script>
