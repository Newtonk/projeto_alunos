
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.4/select2.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-css/1.4.6/select2-bootstrap.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.4/select2.min.js"></script>

<style>
#divAgeDataComparation {
display: block;
max-width: 944px;
max-height: 472px;
margin: auto;
}

</style>

<div id="div_age_vs_data" class="col-md-12">
<form id="myform" method="POST" action="" enctype = "multipart/form-data" onchange="handlerAgeDataComparation">
{% csrf_token %}
<label for="entityAgeDataComparation">Comparacao por:</label>
<select name="entityAgeDataComparation" id="entityAgeDataComparation">
     <option value="Empresa" selected>Empresa</option>
     <option value="Area">Area</option>
     <option value="Instituicao">Instituicao</option>
     <option value="Curso">Curso</option>
     <option value="Genero">Genero</option>
     <option value="Classe">Classe Social</option>
</select>
<br>
<label for="statesUniAgeDataComparation">Escolha o Estado da Instituicao:</label>
<input id="statesUniAgeDataComparation">
<br>
<label for="universityAgeDataComparation">Escolha a instituição:</label>
<input id="universityAgeDataComparation">
<br>
<label for="courseAgeDataComparation">Escolha o curso:</label>
<input id="courseAgeDataComparation">
<br>
<label for="statesAgeDataComparation">Escolha o Estado da empresa:</label>
<input id="statesAgeDataComparation">
<br>
<label for="companyAgeDataComparation">Escolha a empresa:</label>
<input id="companyAgeDataComparation" style="width:100%;">
<br>
<label for="areaAgeDataComparation">Escolha a area:</label>
<input id="areaAgeDataComparation" style="width:50%;">
<br>
<label for="genderAgeDataComparation">Escolha o Genero a ser comparado:</label>
<input id="genderAgeDataComparation">
<br>
<label for="classAgeDataComparation">Escolha a classe social:</label>
<input id="classAgeDataComparation">
<br>
<label for="qtyAgeDataComparation">Escolha o numero de elementos máximo:</label>
<select name="qtyAgeDataComparation" id="qtyAgeDataComparation">
  <option value="5">5</option>
  <option value="10" selected>10</option>
  <option value="15">15</option>
  <option value="20">20</option>
</select>
</form>
<div id="divAgeDataComparation">
    <div id="no-data-age-vs-data-comparation">
        <h2>Informação insuficiente para gerar o gráfico</h2>
    </div>
    <canvas id="idadeXdadosCompare" ng-if="data != 0"></canvas>
    <br>
    <br>
</div>
</div>

<!-- Create Request based on the parameters -->
-<script>
	function changeValuesinRequestAgeDataComparation(request)
	{
		var final_request = {};
		$.each($('#myform').serializeArray(), function(_, kv) {
		  final_request[kv.name] = kv.value;
		});
		var companyState = $("#statesAgeDataComparation").select2('data').text;
		final_request["statesAgeDataComparation"] = companyState

        var universityState = $("#statesUniAgeDataComparation").select2('data').text;
		final_request["statesUniAgeDataComparation"] = universityState

		var university = $("#universityAgeDataComparation").select2('data').text;
		final_request["universityAgeDataComparation"] = university

		var company = $("#companyAgeDataComparation").select2('data').text;
		final_request["companyAgeDataComparation"] = company

		var course = $("#courseAgeDataComparation").select2('data').text;
		final_request["courseAgeDataComparation"] = course

		var area = $("#areaAgeDataComparation").select2('data').text;
		final_request["areaAgeDataComparation"] = area

		var gendervalue = $("#genderAgeDataComparation").select2('data').text;
		final_request["genderAgeDataComparation"] = gendervalue

		var classValue = $("#classAgeDataComparation").select2('data').text;
		final_request["classAgeDataComparation"] = classValue

		final_request["graph_name"] = "idadeXdadosCompare"
		return final_request
	}

</script>

<!-- Funções jQuery de atualização e afins -->
<script>
const handlerAgeDataComparation = function(e) {
   var formData = $('#myform').serializeArray()
   e.preventDefault(); // avoid to execute the actual submit of the form.
   formData = changeValuesinRequestAgeDataComparation(formData)
   $.ajax({
        url: "/update_graph/",
        data: formData,
        cache: false,
        dataType: 'json',
        type: 'POST',
        success: function (data, status) {
        		ageDataComparation = data.idadeXdadosCompare
				updateAgeDataComparation(ageDataComparation)

                $("#classAgeDataComparation").empty();
                initValuesAgeDataCompare("Classes", "Class", "#classAgeDataComparation", true)

				$("#genderAgeDataComparation").empty();
				initValuesAgeDataCompare("Genders", "Gender", "#genderAgeDataComparation", true)

				$("#statesUniAgeDataComparation").empty();
				initValuesAgeDataCompare("UniversityStates", "UniversityState", "#statesUniAgeDataComparation", true)

				$("#universityAgeDataComparation").empty();
				initValuesAgeDataCompare("Universities", "University", "#universityAgeDataComparation", true)

				$("#courseAgeDataComparation").empty();
				initValuesAgeDataCompare("Courses", "Course", "#courseAgeDataComparation", true)

				$("#statesAgeDataComparation").empty();
				initValuesAgeDataCompare("CompanyStates", "CompanyState", "#statesAgeDataComparation", true)

				$("#companyAgeDataComparation").empty();
				initValuesAgeDataCompare("Companies", "Company", "#companyAgeDataComparation", true)

				$("#areaAgeDataComparation").empty();
				initValuesAgeDataCompare("Areas", "Area", "#areaAgeDataComparation", true)

                document.getElementById("qtyAgeDataComparation").value = ageDataComparation["Total"];
				document.getElementById("entityAgeDataComparation").value = ageDataComparation["Entity"];
        }
    });
}

var select = document.getElementById('myform');
select.addEventListener('change', handlerAgeDataComparation);

$('#genderAgeDataComparation').on('change', handlerAgeDataComparation)
$('#statesUniAgeDataComparation').on('change', handlerAgeDataComparation)
$('#universityAgeDataComparation').on('change', handlerAgeDataComparation)
$('#courseAgeDataComparation').on('change', handlerAgeDataComparation)
$('#statesAgeDataComparation').on('change', handlerAgeDataComparation)
$('#areaAgeDataComparation').on('change', handlerAgeDataComparation)
$('#classAgeDataComparation').on('change', handlerAgeDataComparation)

</script>

<!-- Método que realiza a atualização do gráfico -->
<script>
function updateAgeDataComparation(object_all)
{
	if (Object.keys(object_all).length == 0 || Object.keys(object_all["Data"]).length == 0)
	{
	    document.getElementById('no-data-age-vs-data-comparation').style.display = 'block';
        document.getElementById('idadeXdadosCompare').style.display = 'none'
    }
    else
    {
        document.getElementById('no-data-age-vs-data-comparation').style.display = 'none';
        document.getElementById('idadeXdadosCompare').style.display = 'block'
        var colorArray = [ 'blue'];
        chartAgeDataComparation.data.labels = object_all["Entities"]
        chartAgeDataComparation.data.datasets[0].backgroundColor = colorArray[0]
        chartAgeDataComparation.data.datasets[0].data = object_all["Data"]
        chartAgeDataComparation.update();
	}
}
</script>

<!-- Função que cria o gráfico inicialmente -->
<script>
function createGraphAgeDataComparation(object_all)
{
var colorArray = [ 'blue'];

chartAgeDataComparation = new Chart(document.getElementById("idadeXdadosCompare"), {
        type: 'bar',
        data: {
          labels: object_all["Entities"],
          datasets: [{
                label : "Media de Idade",
                backgroundColor: colorArray[0],
                data: object_all["Data"]
            }]
        },
        options: {
        scales: {
        yAxes: [{
            ticks: {
                min: 0,
                max: 100,
                stepSize: 20
            }
        }]
        },
        title: {
            display: true,
            text: 'Comparativo de Media de Idade'
         },
        }
        });
}
</script>

<!-- Função do método init -->
<script>
function initAgeDataComparation(object_all) {

    if (Object.keys(object_all).length == 0)
    {
        document.getElementById("div_age_vs_data").innerHTML = "Sem informações suficientes para gerar os gráficos!";
    }
    else
    {
    if (Object.keys(object_all["Data"]).length == 0)
	{
		document.getElementById('no-data-age-vs-data-comparation').style.display = 'block';
        document.getElementById('idadeXdadosCompare').style.display = 'none'
	}

    initValuesAgeDataCompare("Classes", "Class", "#classAgeDataComparation", true)
    initValuesAgeDataCompare("Genders", "Gender", "#genderAgeDataComparation", true)
    initValuesAgeDataCompare("UniversityStates", "UniversityState", "#statesUniAgeDataComparation", true)
    initValuesAgeDataCompare("Universities", "University", "#universityAgeDataComparation", true)
    initValuesAgeDataCompare("Courses", "Course", "#courseAgeDataComparation", true)
    initValuesAgeDataCompare("CompanyStates", "CompanyState", "#statesAgeDataComparation", true)
    initValuesAgeDataCompare("Companies", "Company", "#companyAgeDataComparation", true)
    initValuesAgeDataCompare("Areas", "Area", "#areaAgeDataComparation", true)

    createGraphAgeDataComparation(object_all)
    }
}
</script>

<script>

function initValuesAgeDataCompare(all_fields, field, divNameWithTag, hasAllFlag) {
	var testData = [];

	testData.push(
		{
		id : 0,
		text: "Todos"
		});
	// Instead of doing this use the AJAX call to poulate the data.
	for (var i=0; i < ageDataComparation[all_fields].length; i++) {
		testData.push(
		{
		id : i+1,
		text: ageDataComparation[all_fields][i]
		});
	}

	$(divNameWithTag).select2({
	  data: testData,
	  multiple: false,
	  query: function(q) {
      var pageSize,
        results,
        that = this;
      pageSize = 20; // or whatever pagesize
      results = [];
      if (q.term && q.term !== '') {
        // HEADS UP; for the _.filter function i use underscore (actually lo-dash) here
        results = _.filter(that.data, function(e) {
          return e.text.toUpperCase().indexOf(q.term.toUpperCase()) >= 0;
        });
      } else if (q.term === '') {
        results = that.data;
      }
      q.callback({
        results: results.slice((q.page - 1) * pageSize, q.page * pageSize),
        more: results.length >= q.page * pageSize,
      });
    }
	})

	var data = testData.find(o => o.text === ageDataComparation[field])

	$(divNameWithTag).select2("data", data);

}
</script>

<!-- Execucao inicial do método init -->
<script>
    document.getElementById('no-data-age-vs-data-comparation').style.display = 'none';
    var chartAgeDataComparation;
    var ageDataComparation = {{ idadeXdadosCompare | safe }}
    initAgeDataComparation(ageDataComparation);
</script>

