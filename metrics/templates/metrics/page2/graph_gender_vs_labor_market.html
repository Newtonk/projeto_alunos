
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.4/select2.min.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-css/1.4.6/select2-bootstrap.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.4/select2.min.js"></script>

<style>
#divgenerolabormarket {
display: block;
max-width: 944px;
max-height: 472px;
margin: auto;
}

</style>

<div id="div_gender_vs_labor_market" class="col-md-12">
	<form id="myform" action="" onchange="handlerGenderLaborMarket">
	{% csrf_token %}
	<label for="areaGenderXLaborMarket">Escolha a area:</label>
	<select name="areaGenderXLaborMarket" id="areaGenderXLaborMarket" ></select>
	<br>
	<label for="statesGenderXLaborMarket">Escolha a UF da empresa:</label>
	<select name="statesGenderXLaborMarket" id="statesGenderXLaborMarket" ></select>
	<label for="companyGenderXLaborMarket">Escolha a empresa:</label>
	<input id="companyGenderXLaborMarket" name="companyGenderXLaborMarket" style="width:100%;" onclick="handlerGenderLaborMarket"></input>
	</form>
	<div id="divgenerolabormarket">
		<div id="no-data-gender-vs-labor-market">
        	<h2>Informação insuficiente para gerar o gráfico</h2>
    	</div>
		<canvas id="generoXmercadodetrabalho"></canvas>
	</div>
</div>

<!-- Funções jQuery de atualização e afins -->
<script>

const handlerGenderLaborMarket = function(e) {
   var formData = $('#myform').serialize()
   e.preventDefault(); // avoid to execute the actual submit of the form.
   var select2Companies = $("#companyGenderXLaborMarket").select2('data').text;
   formData +=  "&companyGenderXLaborMarket="+select2Companies
   $.ajax({
        url: "/update_graph/",
        data: formData + "&graph_name=generoXmercadodetrabalho",
        cache: false,
        dataType: 'json',
        type: 'POST',
        success: function (data, status) {
				oldStateValue = genderLaborMarket["State"]
        		genderLaborMarket = data.generoXmercadodetrabalho
				updateGraphGenderLaborMarket(genderLaborMarket)
				select = document.getElementById("areaGenderXLaborMarket")
				select.value = genderLaborMarket.Area;
				select = document.getElementById("statesGenderXLaborMarket")
				select.value = genderLaborMarket.State;
				var e = $("#companyGenderXLaborMarket").val()

				selectArea = document.getElementById("areaGenderXLaborMarket")
                $("#areaGenderXLaborMarket").empty();
				var option = document.createElement("option");
				option.value = "Todos";
				option.text = "Todos";
				selectArea.appendChild(option);

				all_areas = genderLaborMarket.Areas;

				for (const area of all_areas)
				{
					var option = document.createElement("option");
					option.value = area;
					option.text = area.charAt(0).toUpperCase() + area.slice(1);
					selectArea.appendChild(option);
				}
				selectArea.value = genderLaborMarket.Area;

				if (oldStateValue != genderLaborMarket.State)
				{
					$("#companyGenderXLaborMarket").empty();
					initCompaniesValues()
					$("#companyGenderXLaborMarket").select2("data", { id: 0, text: "Todos" });
				}
        }
    });
}

var select = document.getElementById('myform');
select.addEventListener('change', handlerGenderLaborMarket);

$('#companyGenderXLaborMarket').on('change', function (e) {
    handlerGenderLaborMarket.call(null,e);
});
</script>

<!-- Método que realiza a atualização do gráfico -->
<script>
function updateGraphGenderLaborMarket(object_all){
	if (Object.keys(object_all).length == 0)
	{
		document.getElementById('no-data-gender-vs-labor-market').style.display = 'block';
        document.getElementById('generoXmercadodetrabalho').style.display = 'none'
	}
	else
	{
	document.getElementById('no-data-gender-vs-labor-market').style.display = 'none';
	document.getElementById('generoXmercadodetrabalho').style.display = 'block'
	var colorArray = ["green", "blue", "black"]
	chartGenderLaborMarket.data.labels = object_all["Labels"]
	chartGenderLaborMarket.data.datasets[0].label = object_all["Area"]
	chartGenderLaborMarket.data.datasets[0].backgroundColor = colorArray
	chartGenderLaborMarket.data.datasets[0].data = object_all["Data"]
	chartGenderLaborMarket.options.title.text = 'Genero X Area de ' + object_all["Area"]
	chartGenderLaborMarket.update();
	}
}


</script>

<!-- Função que cria o gráfico inicialmente -->
<script>
function createGraphGenderLaborMarket(object_all)
{
	var colorArray = ["green", "blue", "black", "red" , "purple"]

	chartGenderLaborMarket = new Chart(document.getElementById("generoXmercadodetrabalho"), {
	type: 'pie',
	data: {
	  labels: object_all["Labels"],
	  datasets: [{
		label : object_all["Area"],
		backgroundColor: colorArray,
		data: object_all["Data"]
	}]
	},
	options: {
	  title: {
		display: true,
		text: 'Genero X Area de ' + object_all["Area"]
	  },
	  plugins: {
		datalabels: {
		formatter: (value, ctx) => {
		  let sum = 0;
		  let dataArr = ctx.chart.data.datasets[0].data;
		  dataArr.map(data => {
			  sum += data;
		  });
		  let percentage = (value*100 / sum).toFixed(2)+"%";
		  return percentage;


		},
		color: '#fff',
		}
	}
	},
	});
}

</script>

<!-- Função do método init -->
<script>
function initGenderLaborMarket(object_all) {

	if (Object.keys(object_all).length == 0)
	{
		document.getElementById("div_gender_vs_labor_market").innerHTML = "Sem informações suficientes para gerar os gráficos!";
	}
	else
	{
	selectArea = document.getElementById("areaGenderXLaborMarket")

	all_courses = object_all["Areas"];

	var option = document.createElement("option");
	option.value = "Todos";
	option.text = "Todos";
	selectArea.appendChild(option);

	for (const area of all_courses)
	{
		var option = document.createElement("option");
		option.value = area;
		option.text = area.charAt(0).toUpperCase() + area.slice(1);
		selectArea.appendChild(option);
	}
	selectArea.value = object_all["Area"];

	selectState = document.getElementById("statesGenderXLaborMarket")

	all_states = object_all["States"];

	var option = document.createElement("option");
	option.value = "Todos";
	option.text = "Todos";
	selectState.appendChild(option);

	for (const state of all_states)
	{
		var option = document.createElement("option");
		option.value = state;
		option.text = state.charAt(0).toUpperCase() + state.slice(1);
		selectState.appendChild(option);
	}
	selectState.value = object_all["State"];

	selectCompany = document.getElementById("companyGenderXLaborMarket")

	createGraphGenderLaborMarket(object_all)
	}
}

</script>

<script>

function initCompaniesValues() {
	var testData = [];

	testData.push(
		{
		id : 0,
		text: "Todos"
		});
	// Instead of doing this use the AJAX call to poulate the data.
	for (var i=0; i < genderLaborMarket["Empresas"].length; i++) {
		testData.push(
		{
		id : i+1,
		text: genderLaborMarket["Empresas"][i]
		});
	}



	$("#companyGenderXLaborMarket").select2({
	  data: testData,
	  placeholder: 'Selecione a empresa...',
	  multiple: false,
	  query: function(q) {
      var pageSize,
        results,
        that = this;
      pageSize = 20; // or whatever pagesize
      results = [];
      if (q.term && q.term !== '') {
        // HEADS UP; for the _.filter function i use underscore (actually lo-dash) here
        results = _.filter(that.data, function(e) {
          return e.text.toUpperCase().indexOf(q.term.toUpperCase()) >= 0;
        });
      } else if (q.term === '') {
        results = that.data;
      }
      q.callback({
        results: results.slice((q.page - 1) * pageSize, q.page * pageSize),
        more: results.length >= q.page * pageSize,
      });
    }
	})
}
</script>

<!-- Execucao inicial do método init -->
<script>
	document.getElementById('no-data-gender-vs-labor-market').style.display = 'none';
	var chartGenderLaborMarket;
	var genderLaborMarket = {{ generoXmercadodetrabalho | safe }}
	initGenderLaborMarket(genderLaborMarket);
	initCompaniesValues()
</script>
