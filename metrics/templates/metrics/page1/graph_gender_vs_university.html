
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
#divgenerouniversidade {
display: block;
max-width: 944px;
max-height: 472px;
margin: auto;
}

</style>

<div id="div_gen_uni" class="col-md-12">
<form id="myform2" method="POST" action="" enctype = "multipart/form-data" onchange="handlerGenderUniversity">
{% csrf_token %}
<label for="qtygenderuniversidade">Escolha o numero de elementos máximo:</label>
<select name="qtygenderuniversidade" id="qtygenderuniversidade">
  <option value="5">5</option>
  <option value="10" selected>10</option>
  <option value="15">15</option>
  <option value="20">20</option>
</select>
<br>
<label for="entitygenderComparation">Comparacao por:</label>
<select name="entitygenderComparation" id="entitygenderComparation">
     <option value="Instituicao" selected>Instituicao</option>
     <option value="Curso">Curso</option>
</select>
<label for="genderComparation">Genero:</label>
<select name="genderComparation" id="genderComparation"></select>
<label for="courseComparation">Curso:</label>
<select name="courseComparation" id="courseComparation"></select>
<br>
<label for="statesComparation">Estado:</label>
<select name="statesComparation" id="statesComparation"></select>
</form>
<div id="divgenerouniversidade">
    <div id="no-data">
        <h2>Informação insuficiente para gerar o gráfico</h2>
    </div>
    <canvas id="generoXuniversidade" ng-if="data != 0"></canvas>
</div>
</div>

<!-- Funções jQuery de atualização e afins -->
<script>
const handlerGenderUniversity = function(e) {
   var formData = $('#myform2').serialize()
   e.preventDefault(); // avoid to execute the actual submit of the form.
   $.ajax({
        url: "/update_graph/",
        data: formData + "&graph_name=generoXuniversidade",
        cache: false,
        dataType: 'json',
        type: 'POST',
        success: function (data, status) {
        		genderUniversity = data.generoXuniversidade
				updateGraphGenderUniversity(genderUniversity)
				select = document.getElementById("statesComparation")
				select.value = genderUniversity.State;
				document.getElementById("qtygenderuniversidade").value = genderUniversity["Total"];
				document.getElementById("entitygenderComparation").value = genderUniversity["Entity"];

				select = document.getElementById("genderComparation")
				 $("#genderComparation").empty();

				 instValues = genderUniversity.Genders;

				 for (const value of instValues)
				 {
					  var option = document.createElement("option");
					  option.value = value;
					  option.text = value.charAt(0).toUpperCase() + value.slice(1);
					  select.appendChild(option);
				 }
				 select.value = genderUniversity.Gender;

				 select = document.getElementById("courseComparation")
				 $("#courseComparation").empty();

                 var option = document.createElement("option");
                 option.value = "Todos";
                 option.text = "Todos";
                 select.appendChild(option);

				 instValues = genderUniversity.Courses;

				 for (const value of instValues)
				 {
					  var option = document.createElement("option");
					  option.value = value;
					  option.text = value.charAt(0).toUpperCase() + value.slice(1);
					  select.appendChild(option);
				 }
				 select.value = genderUniversity.Course;

				 select = document.getElementById("statesComparation")
				 $("#statesComparation").empty();

                instValues = genderUniversity.States;

                var option = document.createElement("option");
                option.value = "Todos";
                option.text = "Todos";
                select.appendChild(option);

                for (const state of instValues)
                {
                    var option = document.createElement("option");
                    option.value = state;
                    option.text = state.charAt(0).toUpperCase() + state.slice(1);
                    select.appendChild(option);
                }
                select.value = genderUniversity.State;

        }
    });
}

var select = document.getElementById('myform2');
select.addEventListener('change', handlerGenderUniversity);

</script>

<!-- Método que realiza a atualização do gráfico -->
<script>
function updateGraphGenderUniversity(object_all)
{
	if (Object.keys(object_all).length == 0 || Object.keys(object_all["Data"]).length == 0)
	{
	    document.getElementById('no-data').style.display = 'block';
        document.getElementById('generoXuniversidade').style.display = 'none'
    }
    else
    {
        document.getElementById('no-data').style.display = 'none';
        document.getElementById('generoXuniversidade').style.display = 'block'
        var colorArray = [ 'blue'];
        chartGenderUniversity.data.labels = object_all["Instituicoes"]
        chartGenderUniversity.data.datasets[0].label = object_all["Gender"]
        chartGenderUniversity.data.datasets[0].backgroundColor = colorArray[0]
        chartGenderUniversity.data.datasets[0].data = object_all["Data"]
        chartGenderUniversity.update();
        chartGenderUniversity.render();
	}
}
</script>

<!-- Função que cria o gráfico inicialmente -->
<script>
function createGraphGenderUniversity(object_all)
{
var colorArray = [ 'blue'];

chartGenderUniversity = new Chart(document.getElementById("generoXuniversidade"), {
        type: 'bar',
        data: {
          labels: object_all["Instituicoes"],
          datasets: [{
                label : object_all["Gender"],
                backgroundColor: colorArray,
                data: object_all["Data"]
            }]
        },
        options: {
        plugins: {
          title: {
            display: true,
            text: 'Comparativo Genero em (%)'
          },
         },
        }
        });
}
</script>

<!-- Função do método init -->
<script>
function initGenderUniversity(object_all) {

if (Object.keys(object_all).length == 0)
{
    document.getElementById("div_gen_uni").innerHTML = "Sem informações suficientes para gerar os gráficos!";
}
else
{
document.getElementById("qtygenderuniversidade").value = object_all["Total"];

select = document.getElementById("statesComparation")

all_states = object_all["States"];

var option = document.createElement("option");
option.value = "Todos";
option.text = "Todos";
select.appendChild(option);

for (const state of all_states)
{
    var option = document.createElement("option");
    option.value = state;
    option.text = state.charAt(0).toUpperCase() + state.slice(1);
    select.appendChild(option);
}
select.value = "{{ generoXuniversidade.State | safe}}";

selectCourse = document.getElementById("courseComparation")

all_courses = object_all["Courses"];

var option = document.createElement("option");
option.value = "Todos";
option.text = "Todos";
selectCourse.appendChild(option);

for (const course of all_courses)
{
    var option = document.createElement("option");
    option.value = course;
    option.text = course.charAt(0).toUpperCase() + course.slice(1);
    selectCourse.appendChild(option);
}
selectCourse.value = object_all["Course"];

selectGender = document.getElementById("genderComparation")

all_genders = object_all["Genders"];

for (const gender of all_genders)
{
    var option = document.createElement("option");
    option.value = gender;
    option.text = gender.charAt(0).toUpperCase() + gender.slice(1);
    selectGender.appendChild(option);
}
selectGender.value = object_all["Gender"];

createGraphGenderUniversity(object_all)
}
}
</script>

<!-- Execucao inicial do método init -->
<script>
    var lastChartGenderUniversity;
    document.getElementById('no-data').style.display = 'none';
    var chartGenderUniversity;
    var genderUniversity = {{ generoXuniversidade | safe }}
    initGenderUniversity(genderUniversity);
</script>
